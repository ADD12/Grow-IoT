{"version":3,"file":"Thing.es6.js","sources":["../lib/Thing.js"],"sourcesContent":["const _ = require('underscore');\nconst later = require('later');\nconst EventEmitter = require('events');\n\n\n/**\n * Class representing a Thing. A Thing is an extension of [node's built-in EventEmitter class](https://nodejs.org/api/events.html).\n * @extends EventEmitter\n */\nclass Thing extends EventEmitter {\n  /**\n   * Constructs a new Thing object.\n   * @constructor\n   * @param {Object} config  an object containing properties, events, and/or actions.\n   * @param {Function} callback  an optional callback\n   * @return     A new thing object\n  */\n  constructor(config, callback) {\n    super();\n\n    if (!config) {\n      throw new Error('Thing.js requires an config object.');\n    } else {\n      _.extend(this, config);\n    }\n\n    this.registerActions();\n    this.registerEvents();\n    this.registerProperties();\n\n    // Callback is optional. May be used for a start function.\n    if (!_.isUndefined(callback)) {\n      callback();\n    }\n  }\n\n  /**\n   * Run when the Thing is initialized. Starts any scheduled actions.\n   */\n  registerActions () {\n    this.scheduledActions = [];\n\n    if (!_.isUndefined(this.actions)) {\n      _.each(this.actions, (action, key, list) => {\n        if (!_.isUndefined(action.schedule)) {\n          this.startAction(key);\n        }\n      });\n    }\n  }\n\n  /**\n   * Run when the Thing is initialized. Starts listeners and schedules events.\n   */\n  registerEvents () {\n    this.scheduledEvents = [];\n\n    if (!_.isUndefined(this.events)) {\n      _.each(this.events, (event, key, list) => {\n        if (!_.isUndefined(event.schedule)) {\n          this.scheduleEvent(key);\n        }\n\n        if (!_.isUndefined(event.on)) {\n          this.on(event.on, () => {\n            event.function();\n          });\n        }\n      });\n    }\n  }\n\n  /**\n   * Initializes properties.\n   */\n  registerProperties () {\n    if (!_.isUndefined(this.properties)) {\n      for (var property in this.properties) {\n        // If the property is a function we initialize it.\n        if (typeof this.properties[property] === 'function') {\n          // Note this function should return property value.\n          this.properties[property] = this.properties[property]()\n        }\n      }\n    }\n  }\n\n  /**\n   * Get action object\n   * @param {String} ID  The key of the action object you want.\n   * @returns {Object}\n   */\n  getAction (ID) {\n    var action = {};\n    _.each(this.actions, (value, key, list) => {\n      if (key === ID) {\n        return action = value;\n      } else if (this.actions[key].id === ID) {\n        return action = value; \n      }\n    });\n\n    return action;\n  }\n\n  /**\n   * Get list of the Thing's actions\n   * @returns {Object}\n   */\n  getActions () {\n    return this.actions;\n  }  \n\n  /**\n   * Get event object\n   * @param {String} ID  The key / id of the event object you want.\n   * @returns {Object}\n   */\n  getEvent (ID) {\n    var event = {}\n    _.each(this.events, (value, key, list) => {\n      if (key === ID) {\n        return event = value;\n      } else if (this.events[key].id === ID) {\n        return event = value; \n      }\n    });\n\n    return event;\n  }\n\n  /**\n   * Get list of the Thing's events\n   * @returns {Object}\n   */\n  getEvents () {\n    return this.events;\n  }  \n\n  /**\n   * Update a property based on a component ID.\n   * @param {String} property The property of the component to be update.\n   * @param {String} value The value to update the property to.\n   */\n  setProperty (property, value) {\n    this.properties[property] = value;\n    this.emit('property-updated');\n  }\n\n  /* Get a property by key.\n   * @param {String} property\n   * @returns {String} property value.\n   */\n  getProperty (property) {\n    return this.properties[property];\n  }\n\n  /* Get a Thing's properties\n   * @returns {Object}\n   */\n  getProperties () {\n    return this.properties;\n  }\n\n  /**\n   * Calls a registered action, emits event if the the action has an 'event'\n   * property defined. Updates the state if the action has an 'updateState'\n   * property specified.\n   * @param      {String}  actionId The id of the action to call.\n   * @param      {Object}  options Optional, options to call with the function.\n   */\n  callAction (actionId, options) {\n    try {\n      var action = this.getAction(actionId);\n\n      if (!_.isUndefined(options)) {\n        var output = action.function(options);\n      }\n      else {\n        var output = action.function();\n      }\n      this.emit(actionId);\n\n      // We return any returns of called functions for testing.\n      if (!_.isUndefined(output)) {\n        return output;\n      }\n    }\n    catch (error) {\n      // If there is an error we emit an error.\n      return this.emit('error', error);\n    }\n\n  }\n\n  /**\n   * Starts a reoccurring action if a schedule property is defined.\n   * @param {Object} action An action object.\n   */\n  startAction (actionKey) {\n    var action = this.getAction(actionKey);\n    var schedule = later.parse.text(action.schedule);\n    var scheduledAction = later.setInterval(()=> {this.callAction(actionKey);}, schedule);\n    this.scheduledActions.push(scheduledAction);\n    return scheduledAction;\n  }\n\n  /**\n   * Starts a reoccurring event if a schedule property is defined.\n   * @param {Object} event An event object.\n   */\n  scheduleEvent (eventKey) {\n    var event = this.getEvent(eventKey)\n    var schedule = later.parse.text(event.schedule);\n    var scheduledEvent = later.setInterval(()=> {this.callEvent(eventKey);}, schedule);\n    this.scheduledEvents.push(scheduledEvent);\n    return scheduledEvent;\n  }\n};\n\nexport default Thing;\n"],"names":[],"mappings":"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"}